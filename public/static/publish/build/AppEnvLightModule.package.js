(function(e,t){"object"===typeof exports&&"object"===typeof module?module.exports=t():"function"===typeof define&&define.amd?define([],t):"object"===typeof exports?exports["AppEnvLightModule"]=t():e["AppEnvLightModule"]=t()})("undefined"!==typeof self?self:this,(function(){return function(e){var t={};function r(a){if(t[a])return t[a].exports;var i=t[a]={i:a,l:!1,exports:{}};return e[a].call(i.exports,i,i.exports,r),i.l=!0,i.exports}return r.m=e,r.c=t,r.d=function(e,t,a){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:a})},r.r=function(e){"undefined"!==typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"===typeof e&&e&&e.__esModule)return e;var a=Object.create(null);if(r.r(a),Object.defineProperty(a,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var i in e)r.d(a,i,function(t){return e[t]}.bind(null,i));return a},r.n=function(e){var t=e&&e.__esModule?function(){return e["default"]}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r(r.s="fae3")}({"05f8":function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});class a{constructor(e){this.A=-1,this.B=null,this.C=!1,this.D=null,this.D=e,this.A=a.I++}getUid(){return this.A}update(){null!=this.B&&this.C&&(this.C=!1,this.B.uProbe.update())}getGlobalUinform(){return null!=this.B?this.B.cloneUniform():null}destroy(){null!=this.B&&this.B.destroy(),this.B=null,this.D=null}}a.I=0,t.MaterialPipeBase=a},"084e":function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});class a{constructor(e,t=!0){this.D=null,this.uProbe=null,this.uniform=null,this.D=e,t&&(this.uProbe=e.createShaderUniformProbe(),this.uniform=e.createShaderGlobalUniform())}getNames(){return[]}cloneUniform(){return this.D.cloneShaderGlobalUniform(this.uniform)}buildData(){this.D.updateGlobalUinformDataFromProbe(this.uniform,this.uProbe,this.getNames()),this.uProbe.update()}destroy(){this.uProbe=null,this.uniform=null,this.D=null}}t.GlobalUniformParamBase=a},"1eb2":function(e,t,r){"use strict";if("undefined"!==typeof window){var a=window.document.currentScript,i=r("8875");a=i(),"currentScript"in document||Object.defineProperty(document,"currentScript",{get:i});var n=a&&a.src.match(/(.+\/)[^/]+\.js(\?.*)?$/);n&&(r.p=n[1])}},"2a4f":function(e,t,r){"use strict";var a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const i=a(r("e78b"));t.EnvLightModule=i.default;class n{constructor(){}createEnvLightModule(e){let t=e.getRenderProxy().uniformContext;return new i.default(t)}}t.Instance=n},"2d85":function(e,t,r){"use strict";var a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const i=a(r("ab73")),n=r("084e");class o extends n.GlobalUniformParamBase{getNames(){return[i.default.EnvLightParams.name]}buildUniformData(){let e=i.default.EnvLightParams.data.slice();return this.uProbe.addVec4Data(e,i.default.EnvLightParams.arrayLength),this.buildData(),e}use(e,t=1){e.addFragUniformParam(i.default.EnvLightParams)}}t.GlobalEnvLightUniformParam=o},5216:function(e,t,r){"use strict";var a;Object.defineProperty(t,"__esModule",{value:!0}),function(e){e[e["ENV_LIGHT_PARAM"]=0]="ENV_LIGHT_PARAM",e[e["ENV_AMBIENT_LIGHT"]=1]="ENV_AMBIENT_LIGHT",e[e["FOG"]=2]="FOG",e[e["FOG_EXP2"]=3]="FOG_EXP2",e[e["VSM_SHADOW"]=4]="VSM_SHADOW",e[e["GLOBAL_LIGHT"]=5]="GLOBAL_LIGHT"}(a||(a={})),t.MaterialPipeType=a},8875:function(e,t,r){var a,i,n;(function(r,o){i=[],a=o,n="function"===typeof a?a.apply(t,i):a,void 0===n||(e.exports=n)})("undefined"!==typeof self&&self,(function(){function e(){var t=Object.getOwnPropertyDescriptor(document,"currentScript");if(!t&&"currentScript"in document&&document.currentScript)return document.currentScript;if(t&&t.get!==e&&document.currentScript)return document.currentScript;try{throw new Error}catch(c){var r,a,i,n=/.*at [^(]*\((.*):(.+):(.+)\)$/gi,o=/@([^@]*):(\d+):(\d+)\s*$/gi,s=n.exec(c.stack)||o.exec(c.stack),u=s&&s[1]||!1,l=s&&s[2]||!1,d=document.location.href.replace(document.location.hash,""),m=document.getElementsByTagName("script");u===d&&(r=document.documentElement.outerHTML,a=new RegExp("(?:[^\\n]+?\\n){0,"+(l-2)+"}[^<]*<script>([\\d\\D]*?)<\\/script>[\\d\\D]*","i"),i=r.replace(a,"$1").trim());for(var f=0;f<m.length;f++){if("interactive"===m[f].readyState)return m[f];if(m[f].src===u)return m[f];if(u===d&&m[f].innerHTML&&m[f].innerHTML.trim()===i)return m[f]}return null}}return e}))},a9bf:function(e,t,r){"use strict";r.r(t),r.d(t,"EnvShaderCode",(function(){return s}));var a="#ifdef VOX_USE_FOG\r\n    #ifdef VOX_FOG_COLOR_MAP\r\n        vec3 fogEnvColor = vec3(1.0);\r\n        vec4 getFogColorFromTexture2D(sampler2D tex) {\r\n            vec4 color = VOX_Texture2D(tex, (u_envLightParams[3].xy + worldPosition.xz) / u_envLightParams[3].zw);\r\n            fogEnvColor = color.xyz;\r\n            return color;\r\n        }\r\n    #endif\r\n    void useFog(inout vec4 color) {\r\n        vec3 fogColor = u_envLightParams[2].xyz;\r\n        #ifdef VOX_FOG_COLOR_MAP\r\n            fogColor *= fogEnvColor;\r\n        #endif\r\n        #ifdef VOX_FOG_EXP2\r\n            float fogDensity = u_envLightParams[2].w;\r\n            float fogFactor = 1.0 - exp( - fogDensity * fogDensity * v_fogDepth * v_fogDepth );\r\n        #else\r\n            float fogNear = u_envLightParams[1].z;\r\n            float fogFar = u_envLightParams[1].w;\r\n            float fogFactor = smoothstep( fogNear, fogFar, v_fogDepth );\r\n        #endif\r\n        #ifdef VOX_USE_BRIGHTNESS_OVERLAY_COLOR\r\n            color.xyz = mix( color.rgb, fogColor, fogFactor ) * length(color.rgb) * (1.0 - fogFactor);\r\n        #else\r\n            color.xyz = mix( color.rgb, fogColor, fogFactor );\r\n            #ifdef VOX_PREMULTIPLY_ALPHA\r\n                color.xyz *= color.w;\r\n            #endif\r\n        #endif\r\n    }\r\n#endif",i="void calcFogDepth(in vec4 viewPos) {\r\n    v_fogDepth = -viewPosition.z;\r\n}",n="#ifdef VOX_FOG_COLOR_MAP\r\n    getFogColorFromTexture2D( VOX_FOG_COLOR_MAP );\r\n#endif\r\n\r\n#ifdef VOX_USE_FOG\r\n    useFog( FragColor0 );\r\n#endif ",o="#ifdef VOX_USE_FOG\r\n\r\ncalcFogDepth(viewPosition);\r\n\r\n#endif";const s={vert:"",vert_head:i,vert_body:o,frag:"",frag_head:a,frag_body:n}},ab73:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});class a{constructor(){this.type="vec4",this.data=null,this.name="u_vsmParams",this.arrayLength=3}}class i{constructor(){this.type="vec4",this.data=new Float32Array([.1,.1,.1,1,1,.1,600,3500,.3,0,.9,5e-4,0,0,800,800,-500,-500,1e3,1e3]),this.name="u_envLightParams",this.arrayLength=5}}class n{constructor(){this.type="mat4",this.data=null,this.name="u_shadowMat",this.arrayLength=0}}class o{constructor(){this.type="vec4",this.data=null,this.name="u_stageParam",this.arrayLength=0}}class s{constructor(){this.type="vec4",this.data=null,this.name="u_viewParam",this.arrayLength=0}}class u{constructor(){this.type="vec4",this.data=null,this.name="u_frustumParam",this.arrayLength=0}}class l{constructor(){this.type="vec4",this.data=null,this.name="u_cameraPosition",this.arrayLength=0}}class d{constructor(){this.type="vec4",this.positionName="u_lightPositions",this.colorName="u_lightColors"}}class m{}m.LocalTransformMatUNS="u_objMat",m.CameraViewMatUNS="u_viewMat",m.CameraProjectiveMatUNS="u_projMat",m.FrustumParam=new u,m.CameraPosParam=new l,m.StageParam=new o,m.ViewportParam=new s,m.ShadowMatrix=new n,m.ShadowVSMParams=new a,m.GlobalLight=new d,m.EnvLightParams=new i,t.default=m},e78b:function(e,t,r){"use strict";var a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const i=a(r("ab73")),n=r("5216"),o=r("05f8"),s=r("a9bf"),u=r("2d85");class l extends o.MaterialPipeBase{constructor(){super(...arguments),this.E=!0,this.F=!0,this.G=null,this.H=null}setEnvAmbientMap(e){this.G!=e&&(null!=this.G&&this.G.__$detachThis(),this.G=e,null!=this.G&&this.G.__$attachThis())}setAmbientColorRGB3f(e,t,r){let a=this.H;a[0]=e,a[1]=t,a[2]=r,this.C=!0}setFogColorRGB3f(e,t,r){let a=this.H;a[8]=e,a[9]=t,a[10]=r,this.C=!0}setFogDensity(e){this.H[11]=e,this.C=!0}setFogNear(e){this.H[6]=e,this.C=!0}setFogFar(e){this.H[7]=e,this.C=!0}setFogAreaOffset(e,t){this.H[12]=e,this.H[13]=t,this.C=!0}setFogAreaSize(e,t){this.H[14]=e,this.H[15]=t,this.C=!0}setEnvAmbientLightAreaOffset(e,t){this.H[16]=e,this.H[17]=t,this.C=!0}setEnvAmbientLightAreaSize(e,t){this.H[18]=e,this.H[19]=t,this.C=!0}resetPipe(){this.E=!0,this.F=!0}getTextures(e,t,r){return null!=this.G&&r==n.MaterialPipeType.ENV_AMBIENT_LIGHT?(null==t&&(t=[]),t.push(this.G),e.uniform.add2DMap("VOX_ENV_AMBIENT_LIGHT_LIGHT_MAP",!0,!0,!1),t):null}useShaderPipe(e,t){if(null!=this.B)switch(t){case n.MaterialPipeType.ENV_LIGHT_PARAM:this.buildUniformCode(e);break;case n.MaterialPipeType.FOG:case n.MaterialPipeType.FOG_EXP2:this.buildUniformCode(e),this.useFogData(e,t==n.MaterialPipeType.FOG_EXP2,!0);break;case n.MaterialPipeType.ENV_AMBIENT_LIGHT:this.buildUniformCode(e);break;default:break}}getPipeTypes(){return[n.MaterialPipeType.ENV_LIGHT_PARAM,n.MaterialPipeType.FOG,n.MaterialPipeType.FOG_EXP2,n.MaterialPipeType.ENV_AMBIENT_LIGHT]}getPipeKey(e){switch(e){case n.MaterialPipeType.ENV_LIGHT_PARAM:case n.MaterialPipeType.FOG:case n.MaterialPipeType.FOG_EXP2:case n.MaterialPipeType.ENV_AMBIENT_LIGHT:return"["+e+"]";default:break}return""}useUniforms(e){null!=this.B&&e.addFragUniformParam(i.default.EnvLightParams)}buildUniformCode(e){this.F&&(this.F=!1,this.B.use(e))}useFogData(e,t,r){e.addDefine("VOX_USE_FOG","1"),t&&e.addDefine("VOX_FOG_EXP2","1"),e.addVarying("float","v_fogDepth"),this.useShaderCode(e,r)}useShaderCode(e,t){this.E&&(this.E=!1,t?e.addShaderObject(s.EnvShaderCode):e.addShaderObjectHead(s.EnvShaderCode))}initialize(){if(null==this.B){let e=new u.GlobalEnvLightUniformParam(this.D);this.H=e.buildUniformData(),this.B=e}}destroy(){this.setEnvAmbientMap(null),this.H=null,super.destroy()}}t.default=l},fae3:function(e,t,r){"use strict";r.r(t);r("1eb2");var a=r("2a4f");for(var i in a)["default"].indexOf(i)<0&&function(e){r.d(t,e,(function(){return a[e]}))}(i)}})}));